<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
<title>radioPlayByButton</title>
<style>
div#newButtonDialog,
#advancedButtonDialog {
    display: none;
    position: absolute;
    z-index: 100;
    background: white;
    width: 60ch;
    height: 27ch;
    top: 10%;
    left: 30%;
    padding: 0 10ch;
    border: 1px solid;
    border-radius: 20px;
    box-shadow: 0 0 24px -2px;
}

div#newButtonDialog.show,
#advancedButtonDialog.show {
    display: block;
}

.waiting div#archiveSelection {
    display: none;
}

.waiting div#newButtonKey {
    background: rgba(200,0,0,0.8);
    padding: 2ch;
    font-size: large;
    width:unset;
}

div#newButtonKey {
    font-size: xxx-large;
    background: rgba(0,145,0,0.8);
    padding: 1ch;
    width: 3ch;
    text-align: center;
    float: left;
    margin-right: 10px;
    margin-bottom: 10px;
}

div#archiveSelection {
    font-size: x-large;
}

.buttonKey {
    font-size: xx-large;
    background: rgba(0,140,0,0.8);
    min-width: 3ch;
    text-align: center;
    margin: 6px;
    padding-left:1ch;
    padding-right:1ch;
}

.playing .buttonKey {
    background: rgba(200,0,0,0.7);
}

.rpbbButton {
    display: flex;
}

.buttonSource {
    margin-top: auto;
    margin-bottom: auto;
}
#config>div {
    margin-top: 2ch;
    border-bottom: 1px solid;
}

.hidden {
    display: none;
}

.rpbbButton div {
    display: inline-block;
}

.rpbbButton button {
    margin-top: auto;
    margin-bottom: auto;
    margin-left: 20px;
}

.buttonSource {
    width: 50%;
    overflow: hidden;
    text-overflow: ellipsis;
}

.volume {
}

.volume input[type="range"] {
    height: 5px;
}

.rpbbButton {
    border: 1px solid black;
    border-radius: 20px;
    margin: 10px;
    padding: 10px;
    box-shadow: 3px 3px 14px -6px black;
}

.buttonKey {
    border-radius: 10px;
}

button {
    border-radius: 7px;
    margin: 5px;
}
.buttonDuration {
    margin: 1ch;
    margin-right: 2ch;
    min-width: 14ch;
}

@media only screen and (min-width: 750px){
  div#fileIndex {
      display: grid;
      grid-template-columns: auto auto;
  }
}
@media only screen and (min-width: 1100px){
  div#fileIndex {
      display: grid;
      grid-template-columns: auto auto auto;
  }
}
@media only screen and (min-width: 1500px){
  div#fileIndex {
      display: grid;
      grid-template-columns: auto auto auto auto;
  }
}

.bgrid .rpbbButton {
    width: 40ch;
    overflow: hidden;
    display: grid;
    grid-template-areas:
        "key description volume"
        "key duration delete";
}

.bgrid .buttonKey {
    grid-area: key;
    padding: 0;
}

.bgrid .buttonSource {
    grid-area: description;
    width: unset;
}

.bgrid .buttonDuration {
    grid-area: duration;
}

div#advancedButtonDialog.show {
    display: grid;
    grid-template-areas:
        "title title close"
        "fullpath fullpath ."
        "volume volume ."
        "key checkboxes delete";
    height: unset;
    padding-right: unset;
    grid-template-columns: 1fr 1fr 10ch;
    width: 60vw;
    margin-left: auto;
    margin-right: auto;
}

button.closeDialog {
    grid-area: close;
    height: 6ch;
    background: none;
}

#advancedButtonDialog h1 {
    grid-area: title;
}

div#advancedButtonDialogFullPath {
    grid-area: fullpath;
}

div#advancedButtonDialogKey {
    grid-area: key;
}

div#advancedButtonDialogVolume {
    grid-area: volume;
}

div#advancedButtonDialogCheckboxes {
    grid-area: checkboxes;
}

div#advancedButtonDialogDeleteButton {
    grid-area: delete;
}

/*backgroundanimation*/
.rpbbButton {
    background: linear-gradient(to right, rgba(100,0,0,0.7) 50%, transparent 50%);
    background-size: 200% 100%;
    background-position: right top;
    transition: all 2s ease;
}

.rpbbButton.playing {
    background-position: bottom left;
}

</style>
<script src="FileSaver.js"></script>
<script>
version = 0.1;

function pBB(button, audiosource, bpath){
    this.button = button;
    if(bpath)this.basepath = bpath;
    this.basepath = document.getElementById("basepath").value;
    if(this.basepath.length<1){
        alert("you have to set the basepath before choosing a file\nTienes que configurar la carpeta base de tus archivos");
         document.getElementById("basepath").classList.add("unset");
         document.getElementById("basepath").focus();
        return;
    }
    if(this.basepath.charAt(this.basepath.length-1)!="/")this.basepath+="/";
    if(typeof audiosource === "string"){
        this.audioname = audiosource;
        this.audiosource = this.basepath+this.audioname;
        this.audio = new Audio(this.audiosource);
        this.audio.attachedKey = this.button;
        this.audio.onloadedmetadata = function(){
            radioPlayByButton.buttons[this.attachedKey].duration = this.duration;
            radioPlayByButton.showFileIndex();
        }
        this.audio.onended = function() {
            radioPlayByButton.audioEnded(this.attachedKey);
            console.log("audio ended");
            console.log(this);
            console.log(this.attachedKey);
        };
    }else{
        return;
    }
    this.play = function(){
        this.audio.play();
    }
    this.stop = function(){
        this.audio.pause();
        this.audio.currentTime = 0;
    }
    this.volume = radioPlayByButton.standardVolume;
    this.audio.volume = this.volume;
}

radioPlayByButton = {
    active:true,
    temporaryButton:null,
    buttons:{},
    playingbuttons:[],
    addButton:function(button,audiosource){
        this.buttons[button] = new pBB(button,audiosource);
    },
    playButton:function(button){
        if(this.active && this.buttons[button]){
            if(this.playingbuttons.indexOf(button)<0){
                this.playingbuttons.push(button);
                this.buttons[button].play();
                var dur = Math.floor(this.buttons[button].duration);
                var rpbbutton = document.getElementById("rpbbid"+button);
                rpbbutton.style.transition = "all " +dur+ "s linear";
                rpbbutton.classList.add("playing");
            }else{
                var choice = document.getElementById("secondClickChoice").value;
                if(choice==="stop"){
                    this.stopButton(button);
                }else if(choice==="restart"){
                    this.stopButton(button);
                    setTimeout("radioPlayByButton.playButton('"+button+"')",10);
                }else if(choice==="fadeout"){
                    this.fadeoutButton(button);
                }
            }
        }
        if(this.temporaryButton!=null)this.setNewButtonKey(button);
    },
    stopButton:function(button){
        if(this.buttons[button]){
            this.buttons[button].stop();
            this.stopYieldDate = new Date().getTime();
        }
        var plb = document.getElementById("rpbbid"+button);
        if(plb){
          plb.style.transition = "all 100ms ease";
          plb.classList.remove("playing");
        }
        console.log(document.getElementById("rpbbid"+button));
        var plind = this.playingbuttons.indexOf(button);
        if(plind>=0)this.playingbuttons.splice(plind,1);
    },
    audioEnded:function(button){
        if(this.buttons[button] && this.buttons[button].loop){
          this.stopButton(button);
          setTimeout("radioPlayByButton.playButton('"+button+"')",10);
          return;
        }
        for(var x=this.playingbuttons.length-1;x>=0;x--)if(this.playingbuttons[x]===button)this.playingbuttons.splice(x,1);
        var abutton  = document.getElementById("rpbbid"+button);
        abutton.style.transition = "all 300ms ease";
        abutton.classList.remove("playing");
    },
    setLoop:function(key,value){
      if(this.buttons[key]){
        this.buttons[key].loop = value;
      }
    },
    stopAll:function(){
        for(var x=0;x<this.playingbuttons.length;x++)this.stopButton(this.playingbuttons[x]);
        this.playingbuttons = new Array();
    },
    checkForButton:function(button){
        if(this.buttons[button])return true;
    },
    createNewButton:function(){
        this.temporaryButton = {key:null,audiosource:null};
        var nbd =  document.getElementById("newButtonDialog");
        nbd.classList.add("show");
        nbd.classList.add("waiting");
        document.getElementById("newButtonKey").innerHTML = "Please press Key you want to connect with File <br>"+
        "Apreta la tecla que quieres usar para el archivo";
        this.active=false;
        var upload = document.getElementById("upload");
        upload.value="";
        upload.onchange = function(e){
            var filename = this.files[0].name;
            radioPlayByButton.finishFile(filename);
        }


    },
    setNewButtonKey:function(button){
        this.temporaryButton.key = button;
        var nbk = document.getElementById("newButtonKey");
        nbk.innerText = button;
        var nbd = document.getElementById("newButtonDialog").classList.remove("waiting");

    },
    finishFile:function(filename){
        this.temporaryButton.audiosource = filename;
        var nbd = document.getElementById("newButtonDialog");
        nbd.classList.remove("show");
        this.addButton(this.temporaryButton.key,filename);
        this.active = true;
        this.temporaryButton = null;
        this.showFileIndex();
    },
    removeButton:function(button){
        if(this.buttons[button])delete this.buttons[button];
        this.showFileIndex();
    },
    setVolume:function(button,volume){
        if(this.buttons[button]){
            this.buttons[button].audio.volume = volume/100;
            this.buttons[button].volume = volume/100;
        }
    },
    showAdvancedMenu:function(key){
        var advbdialog = document.getElementById("advancedButtonDialog");
        var dialogtitle = document.getElementById("advancedButtonDialogTitle");
        var dialogfullpath = document.getElementById("advancedButtonDialogFullPath");
        var dialogvolume = document.getElementById("advancedButtonDialogVolumeInput");
        var dialogdelb = document.getElementById("advancedButtonDialogDeleteButtonButton");
        var dialogkey = document.getElementById("advancedButtonDialogKey");
        var abutton = this.buttons[key];
        dialogtitle.innerText = abutton.audioname;
        dialogkey.innerText = key;
        dialogfullpath.innerText = "full path / Ruta completa:"+abutton.audiosource;
        dialogvolume.value = abutton.volume * 100 || 70;
        dialogvolume.attachedKey = key;
        dialogvolume.onchange = function(e){
          radioPlayByButton.setVolume(this.attachedKey,this.value);

        }
        dialogdelb.attachedKey = key;
        dialogdelb.onclick = function(e){
          radioPlayByButton.removeButton(this.attachedKey);
        }

        advbdialog.classList.add("show");
    },
    showFileIndex:function(){
        var fidiv = document.getElementById("fileIndex");
        fidiv.innerHTML = "";
        Object.keys(this.buttons).forEach(function(key,index) {
            // key: the name of the object key
            // index: the ordinal position of the key within the object

            var audiosource = radioPlayByButton.buttons[key].audiosource;
            var audioname = radioPlayByButton.buttons[key].audioname;
            var volume = radioPlayByButton.buttons[key].audio.volume * 100;
            var duration = Math.floor(radioPlayByButton.buttons[key].duration*100)/100;
            let durationminutes = Math.floor(duration/60);
            let durationseconds = Math.floor((duration - (durationminutes *60))*100)/100;
            duration = durationminutes + " min "+durationseconds+" s";
            var loop = radioPlayByButton.buttons[key].loop;
            if(loop)loop=" checked";else loop="";

            var fidiv = document.getElementById("fileIndex");
            var htmlstring = fidiv.innerHTML +
'<div class="rpbbButton" id="rpbbid'+key+'"><button class="buttonKey" onclick="radioPlayByButton.playButton(\''+key+'\')">'+key+'</button>'+
'<div class="buttonSource" title="'+audiosource+'">'+audioname+'</div>'+
'<div class="buttonDuration">'+duration+'</div>'+
'<div class="volume">Base-Volume:<input type="range" onchange="radioPlayByButton.setVolume(\''+key+'\',this.value)" value="'+volume+'" min="1" max="100"></div>'+
'<div class="checkbox"><label>loop</label><input type="checkbox" onclick="radioPlayByButton.setLoop(\''+key+'\',this.value)"'+loop+'></div>'+
'<button onclick="radioPlayByButton.removeButton(\''+key+'\')">delete<br>borrar</button></div>';
            fidiv.innerHTML = htmlstring;
        });
        if(Object.keys(this.buttons).length>5)fidiv.classList.add("bgrid");
        this.saveToCache();
    },
    saveToCache:function(){
        var saveObject = JSON.stringify(this.buttons);
        var saveConfig = JSON.stringify({
          fader:this.fader,
          secondClick:document.getElementById("secondClickChoice").value
        });
        var basepath = document.getElementById("basepath").value;
        window.localStorage.setItem("radioPBBbasepath",basepath);
        window.localStorage.setItem("radioPBBfiles",saveObject);
        window.localStorage.setItem("radioPBBconfig",saveConfig);
    },
    loadFromCache:function(){
        var basepath = window.localStorage.getItem("radioPBBbasepath");
        if(basepath)document.getElementById("basepath").value = basepath;
        var cbstring = window.localStorage.getItem("radioPBBfiles");
        if(cbstring){
            var cachedbuttons = JSON.parse(cbstring);
            var keys = Object.keys(cachedbuttons);
            for(var x=0;x<keys.length;x++){
                var actb = cachedbuttons[keys[x]];
                this.addButton(actb.button, actb.audioname, actb.basepath);

            }
        }
        var configstring = window.localStorage.getItem("radioPBBconfig");
        if(configstring){
          var configobj = JSON.parse(configstring);
          if(configobj.fader){
            this.fader=configobj.fader;
            document.getElementById("configFaderTime").value = this.fader.fadeouttime;
            document.getElementById("configFaderMultiplicator").value = this.fader.multiplicator;
            document.getElementById("configFaderSteps").value = this.fader.steps;
          }
          if(configobj.standardVolume)this.standardVolume=configobj.standardVolume;
          if(configobj.secondClick)document.getElementById("secondClickChoice").value=configobj.secondClick;

        }
        this.showFileIndex();
    },
    loadFromDisc:function(jsonstring){
        var saveObject = JSON.parse(jsonstring);
        document.getElementById("basepath").value=saveObject.basepath;
         var cachedbuttons = saveObject.buttons
         var keys = Object.keys(cachedbuttons);
         for(var x=0;x<keys.length;x++){
                var actb = cachedbuttons[keys[x]];
                this.addButton(actb.button, actb.audioname, actb.basepath);
        }
        if(saveObject.fader){
          this.fader=saveObject.fader;
          document.getElementById("configFaderTime").value = this.fader.fadeouttime;
          document.getElementById("configFaderMultiplicator").value = this.fader.multiplicator;
          document.getElementById("configFaderSteps").value = this.fader.steps;
        }
        if(saveObject.standardVolume)this.standardVolume=saveObject.standardVolume;
        if(saveObject.secondClick)document.getElementById("secondClickChoice").value=saveObject.secondClick;
        this.showFileIndex();
    },
    init:function(){
        this.standardVolume = 0.7;
        this.fader = {
          multiplicator: 0.7,
          fadeouttime:2000,
          steps:10
        }
        this.loadFromCache();
        document.getElementById("configFaderTime").value = this.fader.fadeouttime;
        document.getElementById("configFaderMultiplicator").value = this.fader.multiplicator;
        document.getElementById("configFaderSteps").value = this.fader.steps;
        if(typeof saveAs === "function"){
            var savetoDiskButton = document.createElement("Button");
            savetoDiskButton.innerText = "Save Config + Keys / Guarda Configuracion y keys";
            savetoDiskButton.onclick = function(){
                var saveObject = {};
                saveObject.basepath = document.getElementById("basepath").value;
                saveObject.buttons = radioPlayByButton.buttons;
                saveObject.standardVolume = radioPlayByButton.standardVolume;
                saveObject.fader = radioPlayByButton.fader;
                saveObject.secondClick = document.getElementById("secondClickChoice").value;
                var saveString = JSON.stringify(saveObject);
                var exportfilename = "radioPlayByButtonConfig.txt";
                let blob = new Blob([saveString],{type:"text/plain;charset=utf-8"});
                saveAs(blob, exportfilename);
            }
            document.getElementById("FileSaverDownload").classList.add("hidden");
            var buttonarea = document.getElementById("buttonarea");
            buttonarea.appendChild(savetoDiskButton);
            var loadFromDiscButton = document.createElement("button");
            loadFromDiscButton.innerText = "Load Config + Keys from Disc / Abre Configuracion del disco ";
            loadFromDiscButton.onclick = function(){
                var lfd = document.getElementById("lfdInput");
                if(lfd){
                    lfd.value="";
                    lfd.click();
                }
            }
            var loadFDinput = document.createElement("input");
            loadFDinput.type="file";
            loadFDinput.id="lfdInput";
            loadFDinput.onchange=function(){
                var file = this.files[0];
                 if(file.name.substring(file.name.length-3)==="txt"){
                    var reader = new FileReader();
                    reader.onload = function(e){
                        radioPlayByButton.loadFromDisc(reader.result);
                    }
                    reader.readAsText(file);
                }
            }
            loadFDinput.style.display="none";
            buttonarea.appendChild(loadFDinput);
            buttonarea.appendChild(loadFromDiscButton);
        }else{
          if(confirm("you dont have installed FileSaver.js yet. Do you want to use it directly from the web? to install FileSaver.js once and for all just download it and save it in the same directory as this html-archive."+
          "\nno tienes instalado filesaver.js. quieres usarlo directamente del internet? para ese mensaje desaparece guardate FileSaver.js a la misma carpeta donde esta este archivo mismo: https://raw.githubusercontent.com/eligrey/FileSaver.js/master/dist/FileSaver.js")){
            var jsfile = document.createElement('script');
            jsfile.setAttribute("type","text/javascript");
            jsfile.setAttribute("src", "https://raw.githubusercontent.com/eligrey/FileSaver.js/master/dist/FileSaver.js");
            document.getElementsByTagName("head")[0].appendChild(jsfile);
          }
        }
    },
    fadeout:function(key, restTime, multiplicator,interval, startdate){
        var olddate = startdate;
        if(!olddate)olddate=new Date().getTime();
        var newdate = new Date().getTime();
        var stopyielded = (this.stopYieldDate && this.stopYieldDate > olddate && this.stopYieldDate<newdate);
        var button = radioPlayByButton.buttons[key];
        if(!button)return;
        var oldvolume = button.audio.volume;
        button.audio.volume = oldvolume*multiplicator;
        var actseconds = restTime -interval;
        console.log("fadeout key "+key+" volumeold:"+oldvolume+" -> new volume"+button.audio.volume+" resttime:"+restTime);
        if(restTime>0 && !stopyielded && radioPlayByButton.playingbuttons.indexOf(key)>-1){
     setTimeout("radioPlayByButton.fadeout('"+key+"',"+actseconds+","+multiplicator+","+interval+","+newdate+")",interval);
        }else{
            this.stopButton(key);
            button.audio.volume = button.volume || this.standardVolume;
        }
    },
    fadeoutAll:function(){
        for(var x=0;x<this.playingbuttons.length;x++){
            var actkey = this.playingbuttons[x];
            this.fadeoutButton(actkey);
        }
    },
    fadeoutButton:function(button){
        var fadeouttime = this.fader.fadeouttime;
        var multiplicator = this.fader.multiplicator;
        var interval = fadeouttime / this.fader.steps;
        this.fadeout(button,fadeouttime,multiplicator,interval);
    }

}


window.addEventListener("keyup", function(e){
    if(e.key==="Escape"){
        radioPlayByButton.stopAll();
    }else if(e.key==="Enter"){
        radioPlayByButton.fadeoutAll();
    }else{
        radioPlayByButton.playButton(e.key);
    }
});


</script>
</head>
<body onload="radioPlayByButton.init()">
<h1>radioPlayByButton V 0.2</h1>
<div id="buttonarea">
    <button id="newFileButton" onclick="radioPlayByButton.createNewButton()">Add new File / Añadir nuevo archivo</button>
</div>
<div id="fileIndex">

</div>
<div id="newButtonDialog" class="waiting">
    <h2>Add new File / Añadir nuevo archivo</h2>
    <div id="newButtonKey">
        Please press Key you want to connect with File <br>
        Apreta la tecla que quieres usar para el archivo
    </div>
    <div id="archiveSelection">
        Please select a File / Elige el archivo
        <input type="file" id="upload">
    </div>
</div>
<div id="advancedButtonDialog">
  <button class="closeDialog" onclick="document.getElementById('advancedButtonDialog').classList.remove('show');">close / salir</button>
    <h1>Advanced Options / Opciones avancadas <span id="advancedButtonDialogTitle"></span>
    </h1>
    <div id="advancedButtonDialogFullPath"></div>
    <div id="advancedButtonDialogKey" class="buttonKey"></div>
    <div id="advancedButtonDialogVolume" class="volume">Base-Volume:<input id="advancedButtonDialogVolumeInput" type="range" onchange="radioPlayByButton.setVolume(\''+key+'\',this.value)" value="'+volume+'" min="1" max="100"></div>
    <div id="advancedButtonDialogCheckboxes">
        <div><label>loop</label><input type="checkbox" id="advancedButtonDialogLoop"></div>
    </div>
    <div id="advancedButtonDialogDeleteButton"><button id="advancedButtonDialogDeleteButtonButton">delete<br>borrar</button></div>
</div>
<div id="config">
    <h1>Configuration / Configuración</h1>
    <div>
        <label>Full path to directory containing the files / donde esta la carpeta de tus archivos </label>
        <input type="text" id="basepath"><br>
        <span>Example / ejemplo: /home/me/musica/efectos/</span>
    </div>
    <div>
        <label>what to do on second click if audio of key is still playing / que hace al segundo click si el audio de la tecla esta andando todavia</label>
        <select id="secondClickChoice">
           <option value="stop" selected>Stop / Para</option>
           <option value="restart">Restart / reinicia</option>
           <option value="fadeout">Fadeout / Para bajando</option>
        </select>
    </div>
    <div>
      <h3>Fader</h3>
      <div><label>Time in ms/tiempo en milisegundos</label><input id="configFaderTime" type="text" onkeyup="radioPlayByButton.fader.fadeouttime = this.value;"></div>
      <div><label>multiplicator / multiplicador</label><input id="configFaderMultiplicator" type="text" onkeyup="radioPlayByButton.fader.multiplicator = this.value;"></div>
      <div><label>steps / pasos</label><input id="configFaderSteps" type="text" onkeyup="radioPlayByButton.fader.steps = this.value;"></div>
    </div>
    <div>
        <div id="FileSaverDownload">
        To Save your Config to Disc you have to download FileSaver.js to the same directory this file is within<br>
        Para guardar tu configuración al disco tienes que instalar FileSaver.js a la misma carpeta donde esta este pagina guardado.<br>
        <a href="http://purl.eligrey.com/github/FileSaver.js">Download Filesaver.js</a> |
        </div>
        <div>To Save directly to your Disc we use the Filesaver.js library:<br>
            <a href="https://github.com/eligrey/FileSaver.js/blob/master/LICENSE.md">License</a>
        </div>
    </div>

</div>

<h1>How it works / Como usar</h1>
1. Configure the Base-Directory, the full path to the directory where your audiofiles are stored within<br>
2. Click on Add new File, a Dialog pops up<br>
3. When Dialog is up press Key you want to use<br>
4. After that choose File from your Filesystem to play on this Key<br>
5. If you want you can alter the Base-Volume with the Slider on the Right<br>
====> Just press your Button and it will play back the sound<br>
To Cancel all ongoing sounds just press "Escape"<br>
To Activate "Fade Out" for all press "Enter"<br>
<hr>
1. Configura la carpeta base de tus archivos. Debe tener la Ruta completa a la carpeta donde estan los audios que quieres usar. Si hay más que una carpeta - primero añada todos de una carpeta, cambia la carpeta base y despues sigues con los demás<br>
2. Apreta el Buton "Añadir nuevo archivo". un Dialogo aparece.<br>
3. Si el Dialogo esta visible apreta la tecla que quieres usar para el sonido.<br>
4. Despues elige el archivo que quieres usar (apreta el buton que aparece)<br>
5. Si quieres puedes cambiar el volumen con el slider. <br>
=====> Apreta la tecla y se tira el sonido<br>
Si quieres quitar puedes apretar "Escape" y termina todo<br>
Si quieres quitar lento a todo (fade-out) apreta "Enter"<br>
</body>
</html>
